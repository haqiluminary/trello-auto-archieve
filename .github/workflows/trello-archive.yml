name: Archive Trello Done Lists

on:
  schedule:
    - cron: "0 23 * * 0" # Monday 06:00 UTC+7
  workflow_dispatch:

jobs:
  archive:
    runs-on: ubuntu-latest

    steps:
      - name: Run Trello archive script
        env:
          TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
        run: |
          node <<'EOF'
          const fetch = require("node-fetch");

          const key = process.env.TRELLO_KEY;
          const token = process.env.TRELLO_TOKEN;
          const boardId = process.env.TRELLO_BOARD_ID;
          const base = "https://api.trello.com/1";

          async function main() {
            const res = await fetch(`${base}/boards/${boardId}/lists?key=${key}&token=${token}`);
            const lists = await res.json();

            const doneLists = lists.filter(l => l.name.startsWith("Done in"));

            if (doneLists.length === 0) {
              console.log("No 'Done in' lists found. Skipping archive.");
              return;
            }

            console.log(`Found ${doneLists.length} Done lists. Archiving...`);

            for (const list of doneLists) {
              console.log("Archiving:", list.name);
              await fetch(`${base}/lists/${list.id}/closed?key=${key}&token=${token}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ value: true })
              });
            }

            console.log("Archive completed.");
          }

          main().catch(err => {
            console.error("Error:", err);
            process.exit(1);
          });
          EOF